---
title: Core Entity Package Rules
description: Context and guidelines for the @core-erp/entity shared package
tags: [typescript, supabase, react, entity-management, rbac]
---

# @core-erp/entity - Project Context & Rules

## ğŸ¯ Project Identity

**@core-erp/entity** is a shared npm package that provides:
- Core database types and TypeScript definitions
- Supabase client factory and utilities
- Authentication and authorization contexts
- Permission checking utilities
- React hooks for entity management (users, roles, permissions)
- Zod validation schemas
- Database migrations
- Supabase Edge Functions

## ğŸ“Š Current Status

- **Status**: âœ… Production Ready
- **Version**: 1.0.0
- **Type**: NPM Package (Private)
- **Used By**: core-erp, plugin-erp packages
- **Migration**: âœ… Complete (see MIGRATION_SUMMARY.md)

## ğŸ—ï¸ Technology Stack

### Core Technologies
- TypeScript (strict mode)
- React 18 (peer dependency)
- Supabase JS Client v2
- Zod (validation)
- TanStack React Query v5 (peer dependency)

### Build System
- Vite (library mode)
- TypeScript compiler
- vite-plugin-dts (type generation)

## ğŸ¨ Architecture Principles

### 1. âœ… Configuration Over Convention

**CRITICAL RULE**: This package NEVER reads environment variables directly.

```typescript
// âŒ WRONG - Never do this in core-entity
const url = process.env.VITE_SUPABASE_URL
const key = process.env.VITE_SUPABASE_ANON_KEY

// âœ… CORRECT - Accept configuration from consuming app
const supabase = createSupabaseClient({
  url: import.meta.env.VITE_SUPABASE_URL,
  anonKey: import.meta.env.VITE_SUPABASE_ANON_KEY,
})
```

**Why**: Multiple apps may use this package with different Supabase instances.

### 2. âœ… Provider-Based Architecture

All configuration is passed through React Context providers:

```typescript
<SupabaseProvider client={supabase}>
  <AuthProvider supabaseClient={supabase} toast={toast}>
    <App />
  </AuthProvider>
</SupabaseProvider>
```

### 3. âœ… Zero Side Effects

- No automatic initialization
- No global state
- No singleton patterns
- Everything must be explicitly configured

### 4. âœ… Full TypeScript Support

- 100% TypeScript
- Strict mode enabled
- Comprehensive type exports
- Generated `.d.ts` files

### 5. âœ… Peer Dependencies

React and React Query are peer dependencies to avoid version conflicts:

```json
{
  "peerDependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "@tanstack/react-query": "^5.0.0"
  }
}
```

## ğŸ“ Package Structure

```
core-entity/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # Main exports
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ database.ts             # Database entity types
â”‚   â”‚   â””â”€â”€ config.ts               # Configuration types
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ supabase.ts             # Client factory
â”‚   â”‚   â”œâ”€â”€ permissions.ts          # Permission utilities
â”‚   â”‚   â”œâ”€â”€ constants.ts            # Auth/session constants
â”‚   â”‚   â””â”€â”€ authRetry.ts            # Retry logic
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ user.ts                 # User validation (Zod)
â”‚   â”‚   â”œâ”€â”€ role.ts                 # Role validation
â”‚   â”‚   â”œâ”€â”€ permission.ts           # Permission validation
â”‚   â”‚   â”œâ”€â”€ audit.ts                # Audit log validation
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â”œâ”€â”€ AuthContext.tsx         # Auth + permissions context
â”‚   â”‚   â”œâ”€â”€ SupabaseContext.tsx     # Supabase client provider
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ hooks/
â”‚       â”œâ”€â”€ useAuth.ts              # Access auth context
â”‚       â”œâ”€â”€ useUsers.ts             # User CRUD operations
â”‚       â”œâ”€â”€ useRoles.ts             # Role management
â”‚       â”œâ”€â”€ usePermissions.ts       # Permission queries
â”‚       â”œâ”€â”€ useNetworkStatus.ts     # Network monitoring
â”‚       â”œâ”€â”€ useSessionManagement.ts # Cross-tab session sync
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/                 # Database schema files
â”‚   â”‚   â”œâ”€â”€ 20250110000001_create_core_tables.sql
â”‚   â”‚   â”œâ”€â”€ 20250110000002_seed_roles_and_permissions.sql
â”‚   â”‚   â”œâ”€â”€ 20250110000003_add_user_locale.sql
â”‚   â”‚   â”œâ”€â”€ 20250110000004_create_translations_table.sql
â”‚   â”‚   â””â”€â”€ 20250110000005_seed_translations.sql
â”‚   â””â”€â”€ functions/                  # Edge Functions (Deno)
â”‚       â”œâ”€â”€ _shared/
â”‚       â”‚   â””â”€â”€ cors.ts
â”‚       â”œâ”€â”€ create-user/
â”‚       â”œâ”€â”€ update-user/
â”‚       â”œâ”€â”€ assign-roles/
â”‚       â”œâ”€â”€ get-user-permissions/
â”‚       â””â”€â”€ update-user-locale/
â”œâ”€â”€ dist/                           # Built package
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.build.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ README.md
â””â”€â”€ MIGRATION_SUMMARY.md
```

## ğŸ—„ï¸ Database Schema (Core Tables)

### users
- User profiles (separate from auth.users)
- Fields: id, auth_user_id, name, email, phone, avatar_url, status, locale
- RLS enabled

### roles
- Role definitions with hierarchy
- Fields: id, code, name, level, is_system
- Default roles: superadmin (100), admin (50), user (10)
- RLS enabled

### permissions
- Granular permission definitions
- Fields: id, code, name, description, category
- Format: `resource:action` (e.g., `users:create`)
- RLS enabled

### user_roles
- Many-to-many junction: users â†” roles
- Fields: user_id, role_id, assigned_by, assigned_at
- RLS enabled

### role_permissions
- Many-to-many junction: roles â†” permissions
- Fields: role_id, permission_id
- RLS enabled

### audit_log
- Action tracking
- Fields: id, user_id, action, resource, resource_id, changes, ip_address, user_agent, created_at
- RLS enabled

### translations
- Localization strings
- Fields: id, key, locale, value
- RLS enabled

## ğŸ” Security Model

### Permission Resolution Flow

```
User â†’ user_roles â†’ roles â†’ role_permissions â†’ permissions
```

A user can have multiple roles. Effective permissions = **union** of all role permissions.

### Permission Format

`resource:action` pattern:
- `users:view`, `users:create`, `users:edit`, `users:delete`, `users:manage_roles`
- `roles:view`, `roles:create`, `roles:edit`, `roles:delete`
- `permissions:view`, `permissions:assign`
- `system:configure`, `system:audit`

### Permission Checking Utilities

```typescript
// From useAuth hook
const { hasPermission, hasAnyPermission, hasAllPermissions } = useAuth()

// Single permission
if (!hasPermission('users:create')) {
  return <AccessDenied />
}

// Any of multiple permissions
if (!hasAnyPermission(['users:edit', 'users:create'])) {
  return <AccessDenied />
}

// All permissions required
if (!hasAllPermissions(['users:view', 'users:edit'])) {
  return <AccessDenied />
}
```

## ğŸ“¦ Package Exports

### Main Export

```typescript
import * from '@core-erp/entity'
```

### Granular Exports

```typescript
// Types
import { User, Role, Permission } from '@core-erp/entity'

// Client factory
import { createSupabaseClient } from '@core-erp/entity'

// Schemas
import { userSchema, roleSchema } from '@core-erp/entity'

// Contexts
import { AuthProvider, SupabaseProvider } from '@core-erp/entity'

// Hooks
import { useAuth, useUsers, useRoles } from '@core-erp/entity'

// Utilities
import { hasPermission, checkPermissions } from '@core-erp/entity'
```

## ğŸ”§ Development Guidelines

### Adding New Entity Types

1. **Add type to `src/types/database.ts`**
   ```typescript
   export interface Product {
     id: string
     name: string
     // ...
   }
   ```

2. **Create Zod schema in `src/schemas/product.ts`**
   ```typescript
   import { z } from 'zod'
   
   export const productSchema = z.object({
     name: z.string().min(1),
     // ...
   })
   ```

3. **Create hook in `src/hooks/useProducts.ts`**
   ```typescript
   import { useQuery, useMutation } from '@tanstack/react-query'
   import { useSupabase } from '../contexts/SupabaseContext'
   
   export function useProducts() {
     const supabase = useSupabase()
     // Implementation
   }
   ```

4. **Export from main index**
   ```typescript
   // src/index.ts
   export * from './hooks/useProducts'
   export * from './schemas/product'
   ```

### Adding New Permissions

Permissions should be added via database migration:

```sql
INSERT INTO permissions (code, name, description, category)
VALUES 
  ('products:view', 'View Products', 'Can view product list', 'products'),
  ('products:create', 'Create Products', 'Can create new products', 'products');
```

### Adding Edge Functions

1. **Create function directory**
   ```
   supabase/functions/my-function/
   ```

2. **Add index.ts**
   ```typescript
   import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
   import { corsHeaders } from '../_shared/cors.ts'
   
   serve(async (req) => {
     // Implementation
   })
   ```

3. **Document in docs/**

## ğŸš€ Build & Publish

### Build Package

```bash
npm run build
```

Output:
- `dist/index.js` - Bundled code
- `dist/index.d.ts` - Type definitions
- `dist/**/*.d.ts` - Individual type files

### Publish to NPM Registry

```bash
# Build first
npm run build

# Publish to private registry
npm publish --registry=https://your-private-registry.com
```

### Version Management

Follow semantic versioning:
- **Patch** (1.0.1): Bug fixes, no API changes
- **Minor** (1.1.0): New features, backward compatible
- **Major** (2.0.0): Breaking changes

## ğŸ§ª Testing Strategy

### Type Checking

```bash
npm run type-check
```

### Integration Testing

Test in consuming applications:

```bash
# In core-erp
npm install file:../core-entity
npm run dev
```

### Manual Testing Checklist

- [ ] Authentication flow works
- [ ] Permission checking functions correctly
- [ ] All hooks return correct data
- [ ] Supabase client is properly configured
- [ ] Edge Functions can be called
- [ ] Types are exported correctly

## ğŸ“š Usage in Consuming Apps

### Installation

```bash
# Local development
npm install file:../core-entity

# From private registry
npm install @core-erp/entity
```

### Setup

```typescript
// 1. Create Supabase client
import { createSupabaseClient } from '@core-erp/entity'

export const supabase = createSupabaseClient({
  url: import.meta.env.VITE_SUPABASE_URL,
  anonKey: import.meta.env.VITE_SUPABASE_ANON_KEY,
})

// 2. Wrap app with providers
import { SupabaseProvider, AuthProvider } from '@core-erp/entity'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'

const queryClient = new QueryClient()

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <SupabaseProvider client={supabase}>
        <AuthProvider supabaseClient={supabase} toast={toast}>
          {/* Your app */}
        </AuthProvider>
      </SupabaseProvider>
    </QueryClientProvider>
  )
}

// 3. Use hooks in components
import { useAuth, useUsers } from '@core-erp/entity'

function MyComponent() {
  const { user, hasPermission } = useAuth()
  const { data: users } = useUsers()
  
  if (!hasPermission('users:view')) {
    return <AccessDenied />
  }
  
  // Use users
}
```

## âš ï¸ Important Rules

### DO âœ…

- âœ… Accept all configuration as parameters
- âœ… Use TypeScript strict mode
- âœ… Export all public types
- âœ… Document all public APIs
- âœ… Use Zod for validation
- âœ… Keep contexts minimal
- âœ… Follow semantic versioning
- âœ… Test in consuming apps before publishing

### DON'T âŒ

- âŒ Read environment variables
- âŒ Create global singletons
- âŒ Have side effects on import
- âŒ Bundle React or React Query
- âŒ Hardcode Supabase URLs
- âŒ Skip type exports
- âŒ Break backward compatibility without major version bump
- âŒ Forget to build before publishing

## ğŸ”„ Update Protocol

### When Adding Features

1. Update source code
2. Update types if needed
3. Update documentation
4. Build package
5. Test in consuming app
6. Update version number
7. Publish

### When Fixing Bugs

1. Fix the issue
2. Add test case (if applicable)
3. Build package
4. Test in consuming app
5. Bump patch version
6. Publish

## ğŸ“– Documentation

### Essential Documents

- **README.md** - Package overview and quick start
- **PROJECT_CONTEXT.md** - Complete architecture guide
- **DOCUMENTATION.md** - Documentation index
- **MIGRATION_SUMMARY.md** - Migration details from core-erp

### Cursor Rules

- **.cursor/rules/core-entity-project.mdc** - This file
- **.cursor/rules/documentation-protocol.mdc** - Documentation standards

### Documentation Directory

- **docs/guides/** - How-to guides
- **docs/api/** - API reference
- **docs/architecture/** - Architecture documentation

## ğŸ¯ Success Metrics

### Package Quality
- âœ… 100% TypeScript
- âœ… Zero environment variable reads
- âœ… Full type exports
- âœ… Peer dependencies only
- âœ… Tree-shakeable exports

### Developer Experience
- âœ… Clear API
- âœ… Good documentation
- âœ… Type-safe
- âœ… Easy to test
- âœ… Flexible configuration

### Integration
- âœ… Works in multiple apps
- âœ… No version conflicts
- âœ… Easy to upgrade
- âœ… Backward compatible

---

**Last Updated**: 2025-01-10  
**Maintained By**: Core ERP Team  
**Review Frequency**: Per major feature or monthly
